'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _slateBase64Serializer = require('slate-base64-serializer');

var _slateBase64Serializer2 = _interopRequireDefault(_slateBase64Serializer);

var _findDomNode = require('./find-dom-node');

var _findDomNode2 = _interopRequireDefault(_findDomNode);

var _getWindow = require('get-window');

var _getWindow2 = _interopRequireDefault(_getWindow);

var _environment = require('../constants/environment');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Prepares a Slate document fragment to be copied to the clipboard.
 *
 * @param {Event} event
 * @param {Value} value
 * @param {Document} [fragment]
 */

function cloneFragment(event, value) {
  var fragment = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : value.fragment;

  var window = (0, _getWindow2.default)(event.target);
  var native = window.getSelection();
  var startKey = value.startKey,
      endKey = value.endKey,
      startText = value.startText,
      endBlock = value.endBlock,
      endInline = value.endInline;

  var isVoidBlock = endBlock && endBlock.isVoid;
  var isVoidInline = endInline && endInline.isVoid;
  var isVoid = isVoidBlock || isVoidInline;

  // If the selection is collapsed, and it isn't inside a void node, abort.
  if (native.isCollapsed && !isVoid) return;

  // Create a fake selection so that we can add a Base64-encoded copy of the
  // fragment to the HTML, to decode on future pastes.
  var encoded = _slateBase64Serializer2.default.serializeNode(fragment);
  var range = native.getRangeAt(0);
  var contents = range.cloneContents();
  var attach = contents.childNodes[0];

  // If the end node is a void node, we need to move the end of the range from
  // the void node's spacer span, to the end of the void node's content.
  if (isVoid) {
    var _r = range.cloneRange();
    var n = isVoidBlock ? endBlock : endInline;
    var node = (0, _findDomNode2.default)(n, window);
    _r.setEndAfter(node);
    contents = _r.cloneContents();
    attach = contents.childNodes[contents.childNodes.length - 1].firstChild;
  }

  // COMPAT: in Safari and Chrome when selecting a single marked word,
  // marks are not preserved when copying.
  // If the attatched is not void, and the startKey and endKey is the same,
  // check if there is marks involved. If so, set the range start just before the
  // startText node
  if ((_environment.IS_CHROME || _environment.IS_SAFARI) && !isVoid && startKey === endKey) {
    var hasMarks = startText.characters.slice(value.selection.anchorOffset, value.selection.focusOffset).filter(function (char) {
      return char.marks.size !== 0;
    }).size !== 0;
    if (hasMarks) {
      var _r2 = range.cloneRange();
      var _node = (0, _findDomNode2.default)(startText, window);
      _r2.setStartBefore(_node);
      contents = _r2.cloneContents();
      attach = contents.childNodes[contents.childNodes.length - 1].firstChild;
    }
  }

  // Remove any zero-width space spans from the cloned DOM so that they don't
  // show up elsewhere when pasted.
  var zws = [].slice.call(contents.querySelectorAll('[data-slate-zero-width]'));
  zws.forEach(function (zw) {
    return zw.parentNode.removeChild(zw);
  });

  // COMPAT: In Chrome and Safari, if the last element in the selection to
  // copy has `contenteditable="false"` the copy will fail, and nothing will
  // be put in the clipboard. So we remove them all. (2017/05/04)
  if (_environment.IS_CHROME || _environment.IS_SAFARI) {
    var els = [].slice.call(contents.querySelectorAll('[contenteditable="false"]'));
    els.forEach(function (el) {
      return el.removeAttribute('contenteditable');
    });
  }

  // Set a `data-slate-fragment` attribute on a non-empty node, so it shows up
  // in the HTML, and can be used for intra-Slate pasting. If it's a text
  // node, wrap it in a `<span>` so we have something to set an attribute on.
  if (attach.nodeType == 3) {
    var span = window.document.createElement('span');

    // COMPAT: In Chrome and Safari, if we don't add the `white-space` style
    // then leading and trailing spaces will be ignored. (2017/09/21)
    span.style.whiteSpace = 'pre';

    span.appendChild(attach);
    contents.appendChild(span);
    attach = span;
  }

  attach.setAttribute('data-slate-fragment', encoded);

  // Add the phony content to the DOM, and select it, so it will be copied.
  var editor = window.document.querySelector('[data-slate-editor]');
  var div = window.document.createElement('div');
  div.setAttribute('contenteditable', true);
  div.style.position = 'absolute';
  div.style.left = '-9999px';

  // COMPAT: In Firefox, the viewport jumps to find the phony div, so it
  // should be created at the current scroll offset with `style.top`.
  // The box model attributes which can interact with 'top' are also reset.
  div.style.border = '0px';
  div.style.padding = '0px';
  div.style.margin = '0px';
  div.style.top = (window.pageYOffset || window.document.documentElement.scrollTop) + 'px';

  div.appendChild(contents);
  editor.appendChild(div);

  // COMPAT: In Firefox, trying to use the terser `native.selectAllChildren`
  // throws an error, so we use the older `range` equivalent. (2016/06/21)
  var r = window.document.createRange();
  r.selectNodeContents(div);
  native.removeAllRanges();
  native.addRange(r);

  // Revert to the previous selection right after copying.
  window.requestAnimationFrame(function () {
    editor.removeChild(div);
    native.removeAllRanges();
    native.addRange(range);
  });
}

exports.default = cloneFragment;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9jbG9uZS1mcmFnbWVudC5qcyJdLCJuYW1lcyI6WyJjbG9uZUZyYWdtZW50IiwiZXZlbnQiLCJ2YWx1ZSIsImZyYWdtZW50Iiwid2luZG93IiwidGFyZ2V0IiwibmF0aXZlIiwiZ2V0U2VsZWN0aW9uIiwic3RhcnRLZXkiLCJlbmRLZXkiLCJzdGFydFRleHQiLCJlbmRCbG9jayIsImVuZElubGluZSIsImlzVm9pZEJsb2NrIiwiaXNWb2lkIiwiaXNWb2lkSW5saW5lIiwiaXNDb2xsYXBzZWQiLCJlbmNvZGVkIiwic2VyaWFsaXplTm9kZSIsInJhbmdlIiwiZ2V0UmFuZ2VBdCIsImNvbnRlbnRzIiwiY2xvbmVDb250ZW50cyIsImF0dGFjaCIsImNoaWxkTm9kZXMiLCJyIiwiY2xvbmVSYW5nZSIsIm4iLCJub2RlIiwic2V0RW5kQWZ0ZXIiLCJsZW5ndGgiLCJmaXJzdENoaWxkIiwiaGFzTWFya3MiLCJjaGFyYWN0ZXJzIiwic2xpY2UiLCJzZWxlY3Rpb24iLCJhbmNob3JPZmZzZXQiLCJmb2N1c09mZnNldCIsImZpbHRlciIsImNoYXIiLCJtYXJrcyIsInNpemUiLCJzZXRTdGFydEJlZm9yZSIsInp3cyIsImNhbGwiLCJxdWVyeVNlbGVjdG9yQWxsIiwiZm9yRWFjaCIsInp3IiwicGFyZW50Tm9kZSIsInJlbW92ZUNoaWxkIiwiZWxzIiwiZWwiLCJyZW1vdmVBdHRyaWJ1dGUiLCJub2RlVHlwZSIsInNwYW4iLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJzdHlsZSIsIndoaXRlU3BhY2UiLCJhcHBlbmRDaGlsZCIsInNldEF0dHJpYnV0ZSIsImVkaXRvciIsInF1ZXJ5U2VsZWN0b3IiLCJkaXYiLCJwb3NpdGlvbiIsImxlZnQiLCJib3JkZXIiLCJwYWRkaW5nIiwibWFyZ2luIiwidG9wIiwicGFnZVlPZmZzZXQiLCJkb2N1bWVudEVsZW1lbnQiLCJzY3JvbGxUb3AiLCJjcmVhdGVSYW5nZSIsInNlbGVjdE5vZGVDb250ZW50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VyxNQUFWLEdBQW1CLEtBQW5CO0FBQ0FMLE1BQUlOLEtBQUosQ0FBVVksR0FBVixJQUFtQmpFLE9BQU9rRSxXQUFQLElBQXNCbEUsT0FBT21ELFFBQVAsQ0FBZ0JnQixlQUFoQixDQUFnQ0MsU0FBekU7O0FBRUFULE1BQUlKLFdBQUosQ0FBZ0J0QyxRQUFoQjtBQUNBd0MsU0FBT0YsV0FBUCxDQUFtQkksR0FBbkI7O0FBRUE7QUFDQTtBQUNBLE1BQU10QyxJQUFJckIsT0FBT21ELFFBQVAsQ0FBZ0JrQixXQUFoQixFQUFWO0FBQ0FoRCxJQUFFaUQsa0JBQUYsQ0FBcUJYLEdBQXJCO0FBQ0F6RCxTQUFPcUUsZUFBUDtBQUNBckUsU0FBT3NFLFFBQVAsQ0FBZ0JuRCxDQUFoQjs7QUFFQTtBQUNBckIsU0FBT3lFLHFCQUFQLENBQTZCLFlBQU07QUFDakNoQixXQUFPWixXQUFQLENBQW1CYyxHQUFuQjtBQUNBekQsV0FBT3FFLGVBQVA7QUFDQXJFLFdBQU9zRSxRQUFQLENBQWdCekQsS0FBaEI7QUFDRCxHQUpEO0FBS0Q7O2tCQUVjbkIsYSIsImZpbGUiOiJjbG9uZS1mcmFnbWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IEJhc2U2NCBmcm9tICdzbGF0ZS1iYXNlNjQtc2VyaWFsaXplcidcblxuaW1wb3J0IGZpbmRET01Ob2RlIGZyb20gJy4vZmluZC1kb20tbm9kZSdcbmltcG9ydCBnZXRXaW5kb3cgZnJvbSAnZ2V0LXdpbmRvdydcbmltcG9ydCB7IElTX0NIUk9NRSwgSVNfU0FGQVJJIH0gZnJvbSAnLi4vY29uc3RhbnRzL2Vudmlyb25tZW50J1xuXG4vKipcbiAqIFByZXBhcmVzIGEgU2xhdGUgZG9jdW1lbnQgZnJhZ21lbnQgdG8gYmUgY29waWVkIHRvIHRoZSBjbGlwYm9hcmQuXG4gKlxuICogQHBhcmFtIHtFdmVudH0gZXZlbnRcbiAqIEBwYXJhbSB7VmFsdWV9IHZhbHVlXG4gKiBAcGFyYW0ge0RvY3VtZW50fSBbZnJhZ21lbnRdXG4gKi9cblxuZnVuY3Rpb24gY2xvbmVGcmFnbWVudChldmVudCwgdmFsdWUsIGZyYWdtZW50ID0gdmFsdWUuZnJhZ21lbnQpIHtcbiAgY29uc3Qgd2luZG93ID0gZ2V0V2luZG93KGV2ZW50LnRhcmdldClcbiAgY29uc3QgbmF0aXZlID0gd2luZG93LmdldFNlbGVjdGlvbigpXG4gIGNvbnN0IHsgc3RhcnRLZXksIGVuZEtleSwgc3RhcnRUZXh0LCBlbmRCbG9jaywgZW5kSW5saW5lIH0gPSB2YWx1ZVxuICBjb25zdCBpc1ZvaWRCbG9jayA9IGVuZEJsb2NrICYmIGVuZEJsb2NrLmlzVm9pZFxuICBjb25zdCBpc1ZvaWRJbmxpbmUgPSBlbmRJbmxpbmUgJiYgZW5kSW5saW5lLmlzVm9pZFxuICBjb25zdCBpc1ZvaWQgPSBpc1ZvaWRCbG9jayB8fCBpc1ZvaWRJbmxpbmVcblxuICAvLyBJZiB0aGUgc2VsZWN0aW9uIGlzIGNvbGxhcHNlZCwgYW5kIGl0IGlzbid0IGluc2lkZSBhIHZvaWQgbm9kZSwgYWJvcnQuXG4gIGlmIChuYXRpdmUuaXNDb2xsYXBzZWQgJiYgIWlzVm9pZCkgcmV0dXJuXG5cbiAgLy8gQ3JlYXRlIGEgZmFrZSBzZWxlY3Rpb24gc28gdGhhdCB3ZSBjYW4gYWRkIGEgQmFzZTY0LWVuY29kZWQgY29weSBvZiB0aGVcbiAgLy8gZnJhZ21lbnQgdG8gdGhlIEhUTUwsIHRvIGRlY29kZSBvbiBmdXR1cmUgcGFzdGVzLlxuICBjb25zdCBlbmNvZGVkID0gQmFzZTY0LnNlcmlhbGl6ZU5vZGUoZnJhZ21lbnQpXG4gIGNvbnN0IHJhbmdlID0gbmF0aXZlLmdldFJhbmdlQXQoMClcbiAgbGV0IGNvbnRlbnRzID0gcmFuZ2UuY2xvbmVDb250ZW50cygpXG4gIGxldCBhdHRhY2ggPSBjb250ZW50cy5jaGlsZE5vZGVzWzBdXG5cbiAgLy8gSWYgdGhlIGVuZCBub2RlIGlzIGEgdm9pZCBub2RlLCB3ZSBuZWVkIHRvIG1vdmUgdGhlIGVuZCBvZiB0aGUgcmFuZ2UgZnJvbVxuICAvLyB0aGUgdm9pZCBub2RlJ3Mgc3BhY2VyIHNwYW4sIHRvIHRoZSBlbmQgb2YgdGhlIHZvaWQgbm9kZSdzIGNvbnRlbnQuXG4gIGlmIChpc1ZvaWQpIHtcbiAgICBjb25zdCByID0gcmFuZ2UuY2xvbmVSYW5nZSgpXG4gICAgY29uc3QgbiA9IGlzVm9pZEJsb2NrID8gZW5kQmxvY2sgOiBlbmRJbmxpbmVcbiAgICBjb25zdCBub2RlID0gZmluZERPTU5vZGUobiwgd2luZG93KVxuICAgIHIuc2V0RW5kQWZ0ZXIobm9kZSlcbiAgICBjb250ZW50cyA9IHIuY2xvbmVDb250ZW50cygpXG4gICAgYXR0YWNoID0gY29udGVudHMuY2hpbGROb2Rlc1tjb250ZW50cy5jaGlsZE5vZGVzLmxlbmd0aCAtIDFdLmZpcnN0Q2hpbGRcbiAgfVxuXG4gIC8vIENPTVBBVDogaW4gU2FmYXJpIGFuZCBDaHJvbWUgd2hlbiBzZWxlY3RpbmcgYSBzaW5nbGUgbWFya2VkIHdvcmQsXG4gIC8vIG1hcmtzIGFyZSBub3QgcHJlc2VydmVkIHdoZW4gY29weWluZy5cbiAgLy8gSWYgdGhlIGF0dGF0Y2hlZCBpcyBub3Qgdm9pZCwgYW5kIHRoZSBzdGFydEtleSBhbmQgZW5kS2V5IGlzIHRoZSBzYW1lLFxuICAvLyBjaGVjayBpZiB0aGVyZSBpcyBtYXJrcyBpbnZvbHZlZC4gSWYgc28sIHNldCB0aGUgcmFuZ2Ugc3RhcnQganVzdCBiZWZvcmUgdGhlXG4gIC8vIHN0YXJ0VGV4dCBub2RlXG4gIGlmICgoSVNfQ0hST01FIHx8IElTX1NBRkFSSSkgJiYgIWlzVm9pZCAmJiBzdGFydEtleSA9PT0gZW5kS2V5KSB7XG4gICAgY29uc3QgaGFzTWFya3MgPSBzdGFydFRleHQuY2hhcmFjdGVyc1xuICAgICAgLnNsaWNlKHZhbHVlLnNlbGVjdGlvbi5hbmNob3JPZmZzZXQsIHZhbHVlLnNlbGVjdGlvbi5mb2N1c09mZnNldClcbiAgICAgIC5maWx0ZXIoY2hhciA9PiBjaGFyLm1hcmtzLnNpemUgIT09IDApXG4gICAgICAuc2l6ZSAhPT0gMFxuICAgIGlmIChoYXNNYXJrcykge1xuICAgICAgY29uc3QgciA9IHJhbmdlLmNsb25lUmFuZ2UoKVxuICAgICAgY29uc3Qgbm9kZSA9IGZpbmRET01Ob2RlKHN0YXJ0VGV4dCwgd2luZG93KVxuICAgICAgci5zZXRTdGFydEJlZm9yZShub2RlKVxuICAgICAgY29udGVudHMgPSByLmNsb25lQ29udGVudHMoKVxuICAgICAgYXR0YWNoID0gY29udGVudHMuY2hpbGROb2Rlc1tjb250ZW50cy5jaGlsZE5vZGVzLmxlbmd0aCAtIDFdLmZpcnN0Q2hpbGRcbiAgICB9XG4gIH1cblxuICAvLyBSZW1vdmUgYW55IHplcm8td2lkdGggc3BhY2Ugc3BhbnMgZnJvbSB0aGUgY2xvbmVkIERPTSBzbyB0aGF0IHRoZXkgZG9uJ3RcbiAgLy8gc2hvdyB1cCBlbHNld2hlcmUgd2hlbiBwYXN0ZWQuXG4gIGNvbnN0IHp3cyA9IFtdLnNsaWNlLmNhbGwoY29udGVudHMucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtc2xhdGUtemVyby13aWR0aF0nKSlcbiAgendzLmZvckVhY2goencgPT4gencucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh6dykpXG5cbiAgLy8gQ09NUEFUOiBJbiBDaHJvbWUgYW5kIFNhZmFyaSwgaWYgdGhlIGxhc3QgZWxlbWVudCBpbiB0aGUgc2VsZWN0aW9uIHRvXG4gIC8vIGNvcHkgaGFzIGBjb250ZW50ZWRpdGFibGU9XCJmYWxzZVwiYCB0aGUgY29weSB3aWxsIGZhaWwsIGFuZCBub3RoaW5nIHdpbGxcbiAgLy8gYmUgcHV0IGluIHRoZSBjbGlwYm9hcmQuIFNvIHdlIHJlbW92ZSB0aGVtIGFsbC4gKDIwMTcvMDUvMDQpXG4gIGlmIChJU19DSFJPTUUgfHwgSVNfU0FGQVJJKSB7XG4gICAgY29uc3QgZWxzID0gW10uc2xpY2UuY2FsbChjb250ZW50cy5xdWVyeVNlbGVjdG9yQWxsKCdbY29udGVudGVkaXRhYmxlPVwiZmFsc2VcIl0nKSlcbiAgICBlbHMuZm9yRWFjaChlbCA9PiBlbC5yZW1vdmVBdHRyaWJ1dGUoJ2NvbnRlbnRlZGl0YWJsZScpKVxuICB9XG5cbiAgLy8gU2V0IGEgYGRhdGEtc2xhdGUtZnJhZ21lbnRgIGF0dHJpYnV0ZSBvbiBhIG5vbi1lbXB0eSBub2RlLCBzbyBpdCBzaG93cyB1cFxuICAvLyBpbiB0aGUgSFRNTCwgYW5kIGNhbiBiZSB1c2VkIGZvciBpbnRyYS1TbGF0ZSBwYXN0aW5nLiBJZiBpdCdzIGEgdGV4dFxuICAvLyBub2RlLCB3cmFwIGl0IGluIGEgYDxzcGFuPmAgc28gd2UgaGF2ZSBzb21ldGhpbmcgdG8gc2V0IGFuIGF0dHJpYnV0ZSBvbi5cbiAgaWYgKGF0dGFjaC5ub2RlVHlwZSA9PSAzKSB7XG4gICAgY29uc3Qgc3BhbiA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJylcblxuICAgIC8vIENPTVBBVDogSW4gQ2hyb21lIGFuZCBTYWZhcmksIGlmIHdlIGRvbid0IGFkZCB0aGUgYHdoaXRlLXNwYWNlYCBzdHlsZVxuICAgIC8vIHRoZW4gbGVhZGluZyBhbmQgdHJhaWxpbmcgc3BhY2VzIHdpbGwgYmUgaWdub3JlZC4gKDIwMTcvMDkvMjEpXG4gICAgc3Bhbi5zdHlsZS53aGl0ZVNwYWNlID0gJ3ByZSdcblxuICAgIHNwYW4uYXBwZW5kQ2hpbGQoYXR0YWNoKVxuICAgIGNvbnRlbnRzLmFwcGVuZENoaWxkKHNwYW4pXG4gICAgYXR0YWNoID0gc3BhblxuICB9XG5cbiAgYXR0YWNoLnNldEF0dHJpYnV0ZSgnZGF0YS1zbGF0ZS1mcmFnbWVudCcsIGVuY29kZWQpXG5cbiAgLy8gQWRkIHRoZSBwaG9ueSBjb250ZW50IHRvIHRoZSBET00sIGFuZCBzZWxlY3QgaXQsIHNvIGl0IHdpbGwgYmUgY29waWVkLlxuICBjb25zdCBlZGl0b3IgPSB3aW5kb3cuZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtc2xhdGUtZWRpdG9yXScpXG4gIGNvbnN0IGRpdiA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICBkaXYuc2V0QXR0cmlidXRlKCdjb250ZW50ZWRpdGFibGUnLCB0cnVlKVxuICBkaXYuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnXG4gIGRpdi5zdHlsZS5sZWZ0ID0gJy05OTk5cHgnXG5cbiAgLy8gQ09NUEFUOiBJbiBGaXJlZm94LCB0aGUgdmlld3BvcnQganVtcHMgdG8gZmluZCB0aGUgcGhvbnkgZGl2LCBzbyBpdFxuICAvLyBzaG91bGQgYmUgY3JlYXRlZCBhdCB0aGUgY3VycmVudCBzY3JvbGwgb2Zmc2V0IHdpdGggYHN0eWxlLnRvcGAuXG4gIC8vIFRoZSBib3ggbW9kZWwgYXR0cmlidXRlcyB3aGljaCBjYW4gaW50ZXJhY3Qgd2l0aCAndG9wJyBhcmUgYWxzbyByZXNldC5cbiAgZGl2LnN0eWxlLmJvcmRlciA9ICcwcHgnXG4gIGRpdi5zdHlsZS5wYWRkaW5nID0gJzBweCdcbiAgZGl2LnN0eWxlLm1hcmdpbiA9ICcwcHgnXG4gIGRpdi5zdHlsZS50b3AgPSBgJHt3aW5kb3cucGFnZVlPZmZzZXQgfHwgd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3B9cHhgXG5cbiAgZGl2LmFwcGVuZENoaWxkKGNvbnRlbnRzKVxuICBlZGl0b3IuYXBwZW5kQ2hpbGQoZGl2KVxuXG4gIC8vIENPTVBBVDogSW4gRmlyZWZveCwgdHJ5aW5nIHRvIHVzZSB0aGUgdGVyc2VyIGBuYXRpdmUuc2VsZWN0QWxsQ2hpbGRyZW5gXG4gIC8vIHRocm93cyBhbiBlcnJvciwgc28gd2UgdXNlIHRoZSBvbGRlciBgcmFuZ2VgIGVxdWl2YWxlbnQuICgyMDE2LzA2LzIxKVxuICBjb25zdCByID0gd2luZG93LmRvY3VtZW50LmNyZWF0ZVJhbmdlKClcbiAgci5zZWxlY3ROb2RlQ29udGVudHMoZGl2KVxuICBuYXRpdmUucmVtb3ZlQWxsUmFuZ2VzKClcbiAgbmF0aXZlLmFkZFJhbmdlKHIpXG5cbiAgLy8gUmV2ZXJ0IHRvIHRoZSBwcmV2aW91cyBzZWxlY3Rpb24gcmlnaHQgYWZ0ZXIgY29weWluZy5cbiAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgZWRpdG9yLnJlbW92ZUNoaWxkKGRpdilcbiAgICBuYXRpdmUucmVtb3ZlQWxsUmFuZ2VzKClcbiAgICBuYXRpdmUuYWRkUmFuZ2UocmFuZ2UpXG4gIH0pXG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsb25lRnJhZ21lbnRcbiJdfQ==